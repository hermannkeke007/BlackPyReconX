<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlackPyReconX - Dashboard</title>
    <style>
        :root {
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --container-bg: #2c2c2c; --input-bg: #3a3a3a; --border-color: #555; --header-color: #4CAF50; --shadow-color: rgba(0,0,0,0.5);
        }
        html[data-theme='light'] {
            --bg-color: #f4f4f4; --text-color: #333; --container-bg: #ffffff; --input-bg: #e9e9e9; --border-color: #ccc; --header-color: #2E7D32; --shadow-color: rgba(0,0,0,0.1);
        }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 20px; transition: background-color 0.3s, color 0.3s; }
        .container { max-width: 1200px; margin: auto; }
        .card { background-color: var(--container-bg); padding: 20px; border-radius: 8px; box-shadow: 0 0 15px var(--shadow-color); margin-bottom: 20px; }
        .header-container { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--header-color); padding-bottom: 10px; }
        h1 { color: var(--header-color); margin: 0; }
        h2 { color: var(--header-color); border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .theme-switcher { display: flex; align-items: center; }
        .theme-switcher span { margin-right: 8px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(20px); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="date"] { width: 100%; padding: 10px; background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; box-sizing: border-box; }
        .button-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-group { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px; margin-bottom: 15px; }
        .checkbox-container { display: block; position: relative; padding-left: 35px; cursor: pointer; font-size: 16px; user-select: none; }
        .checkbox-container input { position: absolute; opacity: 0; cursor: pointer; }
        .checkmark { position: absolute; top: 0; left: 0; height: 25px; width: 25px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: 4px; transition: background-color 0.2s; }
        .checkbox-container:hover input ~ .checkmark { background-color: #555; }
        .checkbox-container input:checked ~ .checkmark { background-color: var(--header-color); }
        .checkmark:after { content: ""; position: absolute; display: none; left: 9px; top: 5px; width: 5px; height: 10px; border: solid white; border-width: 0 3px 3px 0; transform: rotate(45deg); }
        .checkbox-container input:checked ~ .checkmark:after { display: block; }
        button { font-family: var(--font-family); text-decoration: none; text-align: center; background-color: var(--header-color); color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; flex-grow: 1; transition: background-color 0.3s; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        button:hover:not(:disabled) { opacity: 0.9; }
        button.special { background-color: #c62828; }
        button.telegram { background-color: #0088cc; }
        #tor-button.enabled { background-color: #ff9800; }
        #tor-button.disabled { background-color: #616161; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .result-box { background-color: var(--bg-color); padding: 10px; border-radius: 4px; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; max-height: 250px; overflow-y: auto; }
        .console-box { min-height: 200px; max-height: 400px; }
        .loader { display: none; margin: 20px auto; width: 40px; height: 40px; border: 4px solid #555; border-top: 4px solid var(--header-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #notification-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; }
        .toast { background-color: #333; color: white; padding: 15px; border-radius: 5px; margin-top: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); opacity: 0; transform: translateY(20px); transition: all 0.5s; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background-color: #4CAF50; }
        .toast.error { border-left: 5px solid #f44336; }
        .status-light { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; vertical-align: middle; transition: background-color 0.5s; }
        .status-active { background-color: #4CAF50; box-shadow: 0 0 8px #4CAF50; }
        .status-inactive { background-color: #f44336; box-shadow: 0 0 8px #f44336; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-container">
            <h1>BlackPyReconX</h1>
            <div class="status-indicators">
                <div class="status-item"> <span id="tor-status-light" class="status-light status-inactive"></span> TOR </div>
                <div class="status-item"> <span id="bot-status-light" class="status-light status-inactive"></span> Bot </div>
            </div>
            <div class="theme-switcher">
                <span id="theme-label">Mode Nuit</span>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </div>
    </div>

    <div class="main-grid">
        <div class="card">
            <h2>Contrôle</h2>
            <div class="form-group">
                <label for="target">Cible (IP, Domaine ou URL)</label>
                <input type="text" id="target" placeholder="Ex: scanme.nmap.org">
            </div>
            <div class="form-group">
                <label>Modules de Scan</label>
                <div class="checkbox-group">
                    <label class="checkbox-container">OSINT
                        <input type="checkbox" value="osint">
                        <span class="checkmark"></span>
                    </label>
                    <label class="checkbox-container">Scan Réseau
                        <input type="checkbox" value="scan">
                        <span class="checkmark"></span>
                    </label>
                    <label class="checkbox-container">Analyse Web
                        <input type="checkbox" value="web">
                        <span class="checkmark"></span>
                    </label>
                </div>
            </div>
            <button id="run-selected-button" onclick="runSelectedScans()" style="width: 100%; padding: 12px; font-size: 18px;">Lancer les Scans Sélectionnés</button>
            
            <hr style="border-color: var(--border-color); margin: 20px 0;">

            <div class="button-group" style="margin-top: 0;">
                <button id="btn-report" onclick="runModule('report')">Générer Rapport</button>
                <button id="btn-exfil" onclick="runModule('exfil')" class="special">Exfiltration</button>
            </div>
             <div class="button-group" style="margin-top: 10px;">
                <button id="tor-button" onclick="toggleTor()">Basculer TOR</button>
                <button onclick="window.open('https://t.me/BlackPyReconX_Bot', '_blank')" class="telegram">Bot Telegram</button>
            </div>
        </div>

        <div class="card">
            <h2>Configuration du Payload</h2>
            <div class="form-group">
                <label for="payload-host">IP de l'attaquant (REVERSE_HOST)</label>
                <input type="text" id="payload-host" placeholder="Votre adresse IP">
            </div>
            <div class="form-group">
                <label for="payload-date">Date d'activation</label>
                <input type="date" id="payload-date">
            </div>
            <button onclick="savePayloadConfig()">Sauvegarder la Configuration</button>
        </div>

        <div class="card">
            <h2>Attaque DoS (TCP Flood)</h2>
            <div class="form-group">
                <label for="dos-port">Port Cible</label>
                <select id="dos-port" class="input-style" style="width: 100%; padding: 10px; background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px;">
                    <option value="80">80 (HTTP)</option>
                    <option value="443">443 (HTTPS)</option>
                    <option value="21">21 (FTP)</option>
                    <option value="22">22 (SSH)</option>
                    <option value="23">23 (Telnet)</option>
                    <option value="25">25 (SMTP)</option>
                    <option value="53">53 (DNS)</option>
                    <option value="110">110 (POP3)</option>
                    <option value="143">143 (IMAP)</option>
                    <option value="389">389 (LDAP)</option>
                    <option value="445">445 (SMB)</option>
                    <option value="3306">3306 (MySQL)</option>
                    <option value="5432">5432 (PostgreSQL)</option>
                    <option value="8080">8080 (HTTP-Alt)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dos-duration">Durée (secondes)</label>
                <input type="number" id="dos-duration" placeholder="Ex: 60" value="60">
            </div>
            <button onclick="runDosAttack()" class="special">Lancer l'Attaque DoS</button>
            <button id="dos-stop-button" onclick="stopDosAttack()" class="special" style="display:none; background-color: #d32f2f;">Arrêter l'Attaque</button>
        </div>

        <div class="card">
            <h2>Attaque par Brute-Force</h2>
            <div class="form-group">
                <label>Type d'Attaque</label>
                <div style="display: flex; gap: 15px;">
                    <label><input type="radio" name="bf_attack_type" value="dictionary" checked onchange="toggleBruteforceFields()"> Dictionnaire</label>
                    <label><input type="radio" name="bf_attack_type" value="bruteforce" onchange="toggleBruteforceFields()"> Force Brute Pure</label>
                </div>
            </div>

            <div class="form-group">
                <label for="bruteforce-service">Service</label>
                <select id="bruteforce-service" onchange="toggleBruteforceWebFields()">
                    <option value="ssh">SSH (22)</option>
                    <option value="ftp">FTP (21)</option>
                    <option value="telnet">Telnet (23)</option>
                    <option value="mysql">MySQL (3306)</option>
                    <option value="postgres">PostgreSQL (5432)</option>
                    <option value="web">HTTP (80)</option>
                    <option value="web">Web Form</option>
                </select>
            </div>

            <!-- Champs pour l'attaque par dictionnaire -->
            <div id="bf-dictionary-fields">
                <div class="form-group">
                    <label for="userlist">Liste d'utilisateurs</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="userlist" value="data/usernames.txt" style="flex-grow: 1;">
                        <button onclick="document.getElementById('userlist-upload').click()">Téléverser</button>
                        <input type="file" id="userlist-upload" style="display: none;" onchange="uploadListFile('userlist-upload', 'userlist')">
                    </div>
                </div>
                <div class="form-group">
                    <label>Type de mot de passe</label>
                    <div style="display: flex; gap: 15px;">
                        <label><input type="radio" name="bf_pass_type" value="list" checked onchange="togglePassFields()"> Liste de mots de passe</label>
                        <label><input type="radio" name="bf_pass_type" value="single" onchange="togglePassFields()"> Mot de passe unique</label>
                    </div>
                </div>
                <div id="passlist-field" class="form-group">
                    <label for="passlist">Liste de mots de passe</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="passlist" value="data/passwords.txt" style="flex-grow: 1;">
                        <button onclick="document.getElementById('passlist-upload').click()">Téléverser</button>
                        <input type="file" id="passlist-upload" style="display: none;" onchange="uploadListFile('passlist-upload', 'passlist')">
                    </div>
                </div>
                <div id="single-password-field" class="form-group" style="display: none;">
                    <label for="bruteforce-password">Mot de passe unique</label>
                    <input type="text" id="bruteforce-password" placeholder="Le mot de passe à tester">
                </div>
            </div>

            <!-- Champs pour la force brute pure -->
            <div id="bf-pure-fields" style="display: none;">
                <div class="form-group">
                    <label for="bruteforce-username">Nom d'utilisateur</label>
                    <input type="text" id="bruteforce-username" placeholder="Ex: root">
                </div>
                <div class="form-group">
                    <label for="bruteforce-charset">Jeu de caractères</label>
                    <select id="bruteforce-charset">
                        <option value="alphanum">Alphanumérique (a-zA-Z0-9)</option>
                        <option value="alpha">Alphabétique (a-zA-Z)</option>
                        <option value="lower">Minuscules (a-z)</option>
                        <option value="upper">Majuscules (A-Z)</option>
                        <option value="digits">Numérique (0-9)</option>
                        <option value="all">Tous les caractères</option>
                    </select>
                </div>
                <div class="form-group" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label for="bruteforce-min-len">Min</label>
                        <input type="number" id="bruteforce-min-len" value="4">
                    </div>
                    <div style="flex: 1;">
                        <label for="bruteforce-max-len">Max</label>
                        <input type="number" id="bruteforce-max-len" value="6">
                    </div>
                </div>
            </div>

            <!-- Champs spécifiques au mode Web -->
            <div id="bruteforce-web-fields" style="display: none;">
                <div class="form-group">
                    <label for="bruteforce-url">URL de Connexion</label>
                    <input type="text" id="bruteforce-url" placeholder="https://exemple.com/login">
                </div>
                <div class="form-group">
                    <label for="bruteforce-user-field">Champ Utilisateur</label>
                    <input type="text" id="bruteforce-user-field" placeholder="username">
                </div>
                <div class="form-group">
                    <label for="bruteforce-pass-field">Champ Mot de Passe</label>
                    <input type="text" id="bruteforce-pass-field" placeholder="password">
                </div>
                <div class="form-group">
                    <label for="bruteforce-fail-string">Chaîne d'Échec</label>
                    <input type="text" id="bruteforce-fail-string" placeholder="Mot de passe incorrect">
                </div>
            </div>

            <button onclick="runBruteforceAttack()" class="special">Lancer le Brute-Force</button>
        </div>
    </div>

    <div class="card">
        <h2>Console de Sortie</h2>
        <div id="loader" class="loader"></div>
        <pre id="results" class="result-box console-box">Bienvenue. Choisissez un module pour commencer.</pre>
        <div id="download-links" class="button-group" style="display: none; margin-top: 10px;">
             <a href="#" id="download-txt" class="download-button" download style="background-color: #f39c12;">Télécharger .txt</a>
             <a href="#" id="download-pdf" class="download-button special" download>Télécharger .pdf</a>
             <a href="#" id="download-html" class="download-button" download style="background-color: #3498db;">Télécharger .html</a>
        </div>
    </div>

    

    <div class="card">
            <div class="card">
            <h2>Sniffer Réseau</h2>
            <div class="form-group">
                <label for="sniffer-iface">Interface</label>
                <select id="sniffer-iface" class="input-style" style="width: 100%; padding: 10px; background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px;">
                    <option value="">Chargement...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="sniffer-filter">Filtre (BPF)</label>
                <input type="text" id="sniffer-filter" placeholder="Ex: host 192.168.1.1 and port 80">
            </div>
            <div class="button-group">
                <button onclick="startSniffer()">Démarrer la Capture</button>
                <button onclick="stopSniffer()" class="special">Arrêter la Capture</button>
            </div>
            <pre id="sniffer-output" class="result-box console-box" style="margin-top: 15px;">Les paquets capturés apparaîtront ici...</pre>
        </div>

    <div class="card">
        <h2>Gestion des Rapports</h2>
        <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 20px;">&#128269;</span>
            <input type="text" id="report-search-input" onkeyup="filterReports()" placeholder="Rechercher un rapport..." style="flex-grow: 1;">
        </div>
        <button onclick="loadReports()">Actualiser la Liste</button>
        <ul id="report-list" style="list-style-type: none; padding: 0; margin-top: 15px; max-height: 200px; overflow-y: auto;">
            <!-- La liste des rapports sera injectée ici par JavaScript -->
        </ul>
        <div class="button-group" style="margin-top: 10px;">
            <button onclick="window.location.href='/config/report'" style="background-color: #8e44ad; width: 100%;">⚙️ Personnaliser les Rapports</button>
        </div>
    </div>

    <div class="card">
        <h2>Panneaux de Résultats</h2>
        <div class="results-grid">
            <div>
                <h3>OSINT</h3>
                <pre id="osint-result-box" class="result-box">{{ results.osint }}</pre>
            </div>
            <div>
                <h3>Scan Réseau</h3>
                <pre id="scan-result-box" class="result-box">{{ results.scan }}</pre>
            </div>
            <div>
                <h3>Analyse Web</h3>
                <pre id="web-result-box" class="result-box">{{ results.web }}</pre>
            </div>
        </div>
    </div>
</div>

<div id="notification-container"></div>

<script>
    // --- INITIALISATION ---
    document.addEventListener('DOMContentLoaded', () => {
        // Theme
        const themeToggle = document.getElementById('theme-toggle');
        const storedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(storedTheme);
        themeToggle.addEventListener('change', () => applyTheme(themeToggle.checked ? 'light' : 'dark'));

        // Initial status updates
        updateTorStatus();
        updateBotStatus();
        
        setInterval(updateTorStatus, 5000); // Update every 5 seconds
        setInterval(updateBotStatus, 5000);
        loadPayloadConfig();
        loadInterfaces();
    });

    // --- THEME ---
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        document.getElementById('theme-toggle').checked = theme === 'light';
        document.getElementById('theme-label').textContent = theme === 'light' ? 'Mode Jour' : 'Mode Nuit';
    }

    // --- NOTIFICATIONS ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('notification-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => container.removeChild(toast), 500);
        }, 4000);
    }

    // --- API CALLS & LOGIC ---

    async function updateTorStatus() {
        try {
            const response = await fetch('/get_tor_status');
            const data = await response.json();
            const light = document.getElementById('tor-status-light');
            light.className = 'status-light ' + (data.tor_enabled ? 'status-active' : 'status-inactive');
        } catch (error) {
            document.getElementById('tor-status-light').className = 'status-light status-inactive';
        }
    }

    async function updateBotStatus() {
        try {
            const response = await fetch('/bot/status');
            const data = await response.json();
            const light = document.getElementById('bot-status-light');
            light.className = 'status-light ' + (data.running ? 'status-active' : 'status-inactive');
        } catch (error) {
            document.getElementById('bot-status-light').className = 'status-light status-inactive';
        }
    }

    // --- LAUNCHERS ---

    // New function for checkboxes
    async function runSelectedScans() {
        const modulesToRun = [];
        document.querySelectorAll('.checkbox-group input:checked').forEach(checkbox => {
            modulesToRun.push(checkbox.value);
        });

        if (modulesToRun.length === 0) {
            showToast('Veuillez sélectionner au moins un module de scan.', 'error');
            return;
        }

        const mainButton = document.getElementById('run-selected-button');
        mainButton.disabled = true;

        for (const moduleName of modulesToRun) {
            await runModule(moduleName); // Await to run them sequentially
        }

        mainButton.disabled = false;
    }

    // Generic function to run a single module
    async function runModule(moduleName, options = {}) {
        const target = document.getElementById('target').value;
        if (!target && !['exfil', 'report', 'tor'].includes(moduleName)) {
            showToast('Veuillez spécifier une cible.', 'error');
            return;
        }

        const button = document.getElementById(`btn-${moduleName}`);
        const loader = document.getElementById('loader');
        const resultsDiv = document.getElementById('results');
        const downloadLinks = document.getElementById('download-links');
        const downloadTxt = document.getElementById('download-txt');
        const downloadPdf = document.getElementById('download-pdf');

        // UI feedback
        loader.style.display = 'block';
        resultsDiv.textContent = `Lancement du module ${moduleName}...`;
        if (button) button.disabled = true;
        downloadLinks.style.display = 'none';

        try {
            const response = await fetch('/run_module', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ module: moduleName, target: target, ...options })
            });
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || 'Erreur inconnue du serveur');

            resultsDiv.textContent = data.output;
            showToast(`Module ${moduleName} terminé.`, 'success');

            // Update dynamic result panels
            const resultBox = document.getElementById(`${moduleName}-result-box`);
            if (resultBox) {
                resultBox.textContent = data.output;
            }

            // Gérer les liens de téléchargement si des fichiers de rapport sont retournés
            const downloadTxt = document.getElementById('download-txt');
            const downloadPdf = document.getElementById('download-pdf');
            const downloadHtml = document.getElementById('download-html');

            const hasReports = data.txt_file || data.pdf_file || data.html_file;
            downloadLinks.style.display = hasReports ? 'flex' : 'none';

            if (data.txt_file) {
                downloadTxt.href = `/download/${data.txt_file}`;
                downloadTxt.style.display = 'inline-block';
            } else {
                downloadTxt.style.display = 'none';
            }

            if (data.pdf_file) {
                downloadPdf.href = `/download/${data.pdf_file}`;
                downloadPdf.style.display = 'inline-block';
            } else {
                downloadPdf.style.display = 'none';
            }

            if (data.html_file) {
                downloadHtml.href = `/download/${data.html_file}`;
                downloadHtml.style.display = 'inline-block';
            } else {
                downloadHtml.style.display = 'none';
            }
        } catch (error) {
            const errorMessage = `Erreur sur ${moduleName}: ${error.message}`;
            resultsDiv.textContent = errorMessage;
            showToast(errorMessage, 'error');
        } finally {
            loader.style.display = 'none';
            if (button) button.disabled = false;
        }
    }

    

    async function toggleTor() {
        const torButton = document.getElementById('tor-button');
        torButton.textContent = 'Mise à jour...';
        torButton.disabled = true;
        try {
            const response = await fetch('/toggle_tor', { method: 'POST' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Erreur inconnue');
            showToast(`TOR est maintenant ${data.tor_enabled ? 'activé' : 'désactivé'}.`);
        } catch (error) {
            showToast(`Erreur TOR: ${error.message}`, 'error');
        } finally {
            torButton.disabled = false;
            torButton.textContent = 'Basculer TOR'; // Restaurer le texte original
            updateTorStatus(); // Mettre à jour le voyant
        }
    }

    // Payload Config
    async function loadPayloadConfig() {
        try {
            const response = await fetch('/config/payload');
            if (!response.ok) throw new Error('Erreur serveur');
            const data = await response.json();
            document.getElementById('payload-host').value = data.host;
            document.getElementById('payload-date').value = `${data.year}-${String(data.month).padStart(2, '0')}-${String(data.day).padStart(2, '0')}`;
        } catch (error) {
            showToast(`Erreur chargement config payload: ${error.message}`, 'error');
        }
    }

    async function savePayloadConfig() {
        const host = document.getElementById('payload-host').value;
        const date = document.getElementById('payload-date').value;
        if (!host || !date) {
            showToast('Veuillez remplir tous les champs du payload.', 'error');
            return;
        }
        try {
            const response = await fetch('/config/payload', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ host, date })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
            showToast(data.message, 'success');
        } catch (error) {
            showToast(`Erreur sauvegarde payload: ${error.message}`, 'error');
        }
    }

    let dosStatusInterval = null;

    async function runDosAttack() {
        const target = document.getElementById('target').value;
        const port = document.getElementById('dos-port').value;
        const duration = document.getElementById('dos-duration').value;

        if (!target || !port || !duration) {
            showToast('Veuillez spécifier une cible, un port et une durée pour l\'attaque DoS.', 'error');
            return;
        }

        const confirmed = confirm(`Êtes-vous sûr de vouloir lancer une attaque DoS sur ${target}:${port} pendant ${duration} secondes ?\nCette action est potentiellement illégale sans autorisation.`);
        if (!confirmed) {
            showToast('Attaque DoS annulée.', 'info');
            return;
        }

        try {
            const response = await fetch('/dos/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target, port: parseInt(port), duration: parseInt(duration) })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);

            showToast(data.message, 'success');
            document.getElementById('dos-stop-button').style.display = 'block';

            // Start polling for status
            dosStatusInterval = setInterval(updateDosStatus, 1000);

        } catch (error) {
            showToast(`Erreur DoS: ${error.message}`, 'error');
        }
    }

    async function updateDosStatus() {
        try {
            const response = await fetch('/dos/status');
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);

            const resultsDiv = document.getElementById('results');
            if (data.running) {
                resultsDiv.textContent = `Attaque en cours sur ${data.target}:${data.port}\n` +
                                     `Paquets par seconde : ${data.pps}\n` +
                                     `Temps écoulé : ${data.elapsed}s / ${data.duration}s`;
            } else {
                resultsDiv.textContent = "L'attaque DoS est terminée.";
                stopDosPolling();
            }
        } catch (error) {
            showToast(`Erreur statut DoS: ${error.message}`, 'error');
            stopDosPolling();
        }
    }

    async function stopDosAttack() {
        try {
            const response = await fetch('/dos/stop', { method: 'POST' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error);
            showToast(data.message, 'success');
        } catch (error) {
            showToast(`Erreur arrêt DoS: ${error.message}`, 'error');
        } finally {
            stopDosPolling();
        }
    }

    function stopDosPolling() {
        if (dosStatusInterval) {
            clearInterval(dosStatusInterval);
            dosStatusInterval = null;
        }
        document.getElementById('dos-stop-button').style.display = 'none';
    }

    function toggleBruteforceFields() {
        const attackType = document.querySelector('input[name="bf_attack_type"]:checked').value;
        document.getElementById('bf-dictionary-fields').style.display = (attackType === 'dictionary') ? 'block' : 'none';
        document.getElementById('bf-pure-fields').style.display = (attackType === 'bruteforce') ? 'block' : 'none';
    }

    function toggleBruteforceWebFields() {
        const service = document.getElementById('bruteforce-service').value;
        document.getElementById('bruteforce-web-fields').style.display = (service === 'web') ? 'block' : 'none';
    }

    function togglePassFields() {
        const passType = document.querySelector('input[name="bf_pass_type"]:checked').value;
        document.getElementById('passlist-field').style.display = (passType === 'list') ? 'block' : 'none';
        document.getElementById('single-password-field').style.display = (passType === 'single') ? 'block' : 'none';
    }

    async function runBruteforceAttack() {
        const attackType = document.querySelector('input[name="bf_attack_type"]:checked').value;
        const service = document.getElementById('bruteforce-service').value;
        const target = document.getElementById('target').value;

        let options = { 
            attack_type: attackType, 
            service: service,
            target: target
        };

        if (attackType === 'dictionary') {
            options.userlist = document.getElementById('userlist').value;
            const passType = document.querySelector('input[name="bf_pass_type"]:checked').value;
            if (passType === 'list') {
                options.passlist = document.getElementById('passlist').value;
            } else {
                options.password = document.getElementById('bruteforce-password').value;
            }
        } else { // bruteforce
            options.username = document.getElementById('bruteforce-username').value;
            options.charset = document.getElementById('bruteforce-charset').value;
            options.min_len = document.getElementById('bruteforce-min-len').value;
            options.max_len = document.getElementById('bruteforce-max-len').value;
            if (!options.username) {
                showToast('Le nom d\'utilisateur est requis pour la force brute pure.', 'error');
                return;
            }
        }

        if (service === 'web') {
            options.url = document.getElementById('bruteforce-url').value;
            options.user_field = document.getElementById('bruteforce-user-field').value;
            options.pass_field = document.getElementById('bruteforce-pass-field').value;
            options.fail_string = document.getElementById('bruteforce-fail-string').value;
            if (!options.url || !options.user_field || !options.pass_field || !options.fail_string) {
                showToast('Veuillez remplir tous les champs pour le mode web.', 'error');
                return;
            }
        } else {
            if (!target) {
                showToast('Veuillez spécifier une cible.', 'error');
                return;
            }
        }

        await runModule('bruteforce', options);
    }

    

    async function uploadListFile(inputId, targetFieldId) {
        const fileInput = document.getElementById(inputId);
        const file = fileInput.files[0];
        if (!file) {
            showToast('Aucun fichier sélectionné.', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        try {
            const response = await fetch('/upload_list', {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Erreur serveur');

            document.getElementById(targetFieldId).value = data.file_path;
            showToast(`Fichier ${data.file_path} téléversé avec succès.`, 'success');
        } catch (error) {
            showToast(`Erreur de téléversement: ${error.message}`, 'error');
        }
    }

    // --- REPORT MANAGEMENT ---
    async function loadReports() {
        try {
            const response = await fetch('/api/reports');
            const files = await response.json();
            if (!response.ok) throw new Error(files.error || 'Erreur inconnue');

            const list = document.getElementById('report-list');
            list.innerHTML = ''; // Vider la liste

            if (files.length === 0) {
                list.innerHTML = '<li>Aucun rapport trouvé.</li>';
                return;
            }

            files.forEach(file => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';
                li.style.alignItems = 'center';
                li.style.padding = '8px';
                li.style.borderBottom = '1px solid var(--border-color)';

                const fileName = document.createElement('span');
                fileName.textContent = file;
                li.appendChild(fileName);

                const buttonContainer = document.createElement('div');

                const openButton = document.createElement('button');
                openButton.textContent = 'Ouvrir';
                openButton.onclick = () => window.open(`/view/report/${file}`, '_blank');
                buttonContainer.appendChild(openButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Supprimer';
                deleteButton.className = 'special';
                deleteButton.style.marginLeft = '10px';
                deleteButton.onclick = () => deleteReport(file);
                buttonContainer.appendChild(deleteButton);

                li.appendChild(buttonContainer);

                list.appendChild(li);
            });

        } catch (error) {
            showToast(`Erreur chargement rapports: ${error.message}`, 'error');
        }
    }

    async function deleteReport(filename) {
        if (!confirm(`Êtes-vous sûr de vouloir supprimer le fichier ${filename} ?`)) return;

        try {
            const response = await fetch('/api/report/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Erreur inconnue');

            showToast(data.message, 'success');
            loadReports(); // Recharger la liste après suppression
        } catch (error) {
            showToast(`Erreur suppression: ${error.message}`, 'error');
        }
    }

    function filterReports() {
        const input = document.getElementById('report-search-input');
        const filter = input.value.toUpperCase();
        const ul = document.getElementById("report-list");
        const li = ul.getElementsByTagName('li');

        for (let i = 0; i < li.length; i++) {
            const span = li[i].getElementsByTagName("span")[0];
            if (span) {
                const txtValue = span.textContent || span.innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    li[i].style.display = "";
                } else {
                    li[i].style.display = "none";
                }
            }
        }
    }

    

    // --- SNIFFER ---
    let snifferInterval = null;

    async function startSniffer() {
        const iface = document.getElementById('sniffer-iface').value;
        const filter = document.getElementById('sniffer-filter').value;

        try {
            const response = await fetch('/sniffer/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ iface, filter })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Erreur inconnue');

            showToast(data.message, 'success');
            document.getElementById('sniffer-output').textContent = 'Capture en cours...';
            snifferInterval = setInterval(updateSnifferStatus, 2000); // Mettre à jour toutes les 2 secondes
        } catch (error) {
            showToast(`Erreur Sniffer: ${error.message}`, 'error');
        }
    }

    async function stopSniffer() {
        try {
            const response = await fetch('/sniffer/stop', { method: 'POST' });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Erreur inconnue');

            showToast(data.message, 'success');
            if (snifferInterval) {
                clearInterval(snifferInterval);
                snifferInterval = null;
            }
        } catch (error) {
            showToast(`Erreur Sniffer: ${error.message}`, 'error');
        }
    }

    async function updateSnifferStatus() {
        try {
            const response = await fetch('/sniffer/status');
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Erreur inconnue');

            const outputDiv = document.getElementById('sniffer-output');
            if (data.packets.length > 0) {
                outputDiv.textContent += '\n' + data.packets.join('\n');
                outputDiv.scrollTop = outputDiv.scrollHeight; // Scroll vers le bas
            }

            if (!data.running && snifferInterval) {
                clearInterval(snifferInterval);
                snifferInterval = null;
                showToast('La capture s\'est arrêtée.', 'info');
            }
        } catch (error) {
            if (snifferInterval) {
                clearInterval(snifferInterval);
                snifferInterval = null;
            }
        }
    }

    async function loadInterfaces() {
        try {
            const response = await fetch('/api/interfaces');
            const interfaces = await response.json();
            if (!response.ok) throw new Error(interfaces.error || 'Erreur inconnue');

            const select = document.getElementById('sniffer-iface');
            select.innerHTML = ''; // Vider les options existantes

            if (interfaces.length === 0) {
                select.innerHTML = '<option value="">Aucune interface trouvée</option>';
                return;
            }

            interfaces.forEach(iface => {
                if (iface.ip !== 'N/A') { // On affiche seulement les interfaces avec une IP
                    const option = document.createElement('option');
                    option.value = iface.name;
                    option.textContent = `${iface.friendly_name} (${iface.ip})`;
                    select.appendChild(option);
                }
            });
        } catch (error) {
            showToast(`Erreur chargement interfaces: ${error.message}`, 'error');
            const select = document.getElementById('sniffer-iface');
            select.innerHTML = '<option value="">Erreur de chargement</option>';
        }
    }

</script>
</body>
</html>